--12. Who Improved the Most Over 5 Years?

WITH latest_year AS (
  SELECT MAX(year) AS max_year
  FROM fact_production
),
wheat_5yr AS (
  SELECT 
    dc.country,
    fp.year,
    SUM(fp.value) AS total_production
  FROM fact_production AS fp
  JOIN dim_item AS di ON fp.item_id = di.item_id
  JOIN dim_element AS de ON fp.element_id = de.element_id
  JOIN dim_country AS dc ON fp.country_id = dc.country_id
  JOIN latest_year ly ON fp.year IN (ly.max_year, ly.max_year - 5)
  WHERE di.item = 'Wheat'
    AND de.element = 'Production'
    AND fp.value IS NOT NULL
  GROUP BY dc.country, fp.year
),
pivoted AS (
  SELECT 
    country,
    MAX(CASE WHEN year = (SELECT max_year FROM latest_year) THEN total_production END) AS prod_now,
    MAX(CASE WHEN year = (SELECT max_year FROM latest_year) - 5 THEN total_production END) AS prod_5yrs_ago
  FROM wheat_5yr
  GROUP BY country
)

SELECT 
  country,
  prod_5yrs_ago,
  prod_now,
  ROUND(prod_now - prod_5yrs_ago,2) AS abs_change,
  ROUND(
    100.0 * (prod_now - prod_5yrs_ago) / NULLIF(prod_5yrs_ago, 0), 
    2
  ) AS pct_change
FROM pivoted
WHERE prod_5yrs_ago IS NOT NULL AND prod_now IS NOT NULL
ORDER BY prod_now DESC;
