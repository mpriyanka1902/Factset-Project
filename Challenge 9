--9. Share of the Global Pie

WITH world_prod AS (
  SELECT 
    fp.year,
    SUM(fp.value) AS world_total
  FROM fact_production AS fp
  JOIN dim_item AS di ON fp.item_id = di.item_id
  JOIN dim_element AS de ON fp.element_id = de.element_id
  JOIN dim_country AS dc ON fp.country_id = dc.country_id
  WHERE di.item = 'Wheat'
    AND de.element = 'Production'
    AND dc.Country_ID IN (36, 89, 157, 201, 70, 8, 32, 142, 193, 197)
    AND fp.value IS NOT NULL
    AND fp.year = 2023
  GROUP BY fp.year
),
france_prod AS (
  SELECT 
    fp.year,
    SUM(fp.value) AS france_total
  FROM fact_production AS fp
  JOIN dim_item AS di ON fp.item_id = di.item_id
  JOIN dim_element AS de ON fp.element_id = de.element_id
  JOIN dim_country AS dc ON fp.country_id = dc.country_id
  WHERE di.item = 'Wheat'
    AND de.element = 'Production'
    AND dc.country = 'France'
    AND fp.value IS NOT NULL
    AND fp.year = 2023
  GROUP BY fp.year
)

SELECT 
  w.year,
  w.world_total,
  g.france_total,
  ROUND(100.0 * g.france_total / NULLIF(w.world_total, 0), 2) AS france_share_percent
FROM world_prod w
JOIN france_prod g ON w.year = g.year
ORDER BY w.year;
